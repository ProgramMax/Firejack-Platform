/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

//@tag opf-editor



Ext.define('OPF.core.component.editor.FieldGridFieldSet', {
    extend: 'OPF.core.component.LabelContainer',

    layout: 'hbox',

    fieldLabel: 'Fields',
    subFieldLabel: '',

    initComponent: function() {
        var instance = this;

        this.store = new Ext.data.Store({
            model: 'OPF.console.domain.model.FieldModel',
            proxy: {
                type: 'memory',
                reader: {
                    type: 'json',
                    idProperty: 'id',
                    root: 'fields'
                },
                writer: {
                    type: 'json'
                }
            }
        });

        this.grid = Ext.create('Ext.grid.Panel', {
            cls: 'border-radius-grid-body border-radius-grid-docked-top',
            store: this.store,
            flex: 1,
            height: 240,
            columns: [
                {
                    xtype: 'gridcolumn',
                    text: '!',
                    dataIndex: 'inherited',
                    sortable: true,
                    align: 'center',
                    width: 30,
                    renderer: function(inherited, metaData, record) {
                        var iconName = 'table_';
                        var autoGenerated = record.get('autoGenerated');
                        if (autoGenerated) {
                            iconName += 'lock';
                        } else if (inherited) {
                            iconName += 'inherited';
                        } else {
                            iconName += 'own';
                        }
                        return '<img src="' + OPF.Ui.icon16(iconName + '_16.png') + '">';
                    }
                },
                OPF.Ui.populateColumn('name', 'Field', {width: 125, renderer: 'htmlEncode'}),
                OPF.Ui.populateColumn('fieldTypeName', 'Type', {width: 125}),
                OPF.Ui.populateBooleanColumn('required', 'Required', {width: 50, trueText: 'Yes', falseText: 'No'}),
                OPF.Ui.populateBooleanColumn('searchable', 'Searchable', {width: 50, trueText: 'Yes', falseText: 'No'}),
                OPF.Ui.populateColumn('defaultValue', 'Default', {width: 100}),
                OPF.Ui.populateColumn('displayName', 'Display Name', {width: 125}),
                OPF.Ui.populateColumn('displayDescription', 'Display Description', {width: 125}),
                OPF.Ui.populateColumn('allowedValues', 'Allowed Values', {flex: 1,
                    renderer: function(inherited, metaData, model) {
                        var allowedValues = model.get('allowedValues');
                        return allowedValues.join(', ');
                    }}
                )
            ],
            viewConfig: {
                plugins: {
                    ptype: 'gridviewdragdrop',
                    dragGroup: 'fieldGridDDGroup'
                }
            },
            tbar: [
                {
                    text: 'Add',
                    iconCls: 'silk-add',
                    handler: function(btn, ev) {
                        instance.getEditorDialog().startEditing();
                    }
                },
                '-',
                {
                    text: 'Delete',
                    iconCls: 'silk-delete',
                    handler: function(btn) {
                        var grid = btn.up('grid');
                        var models = grid.getSelectionModel().getSelection();
                        if (models != null && models.length > 0) {
                            var modelsToDelete = [];
                            for (var i = 0; i < models.length; i++) {
                                var autoGenerated = models[i].get('autoGenerated');
                                var inherited = models[i].get('inherited');
                                if ((OPF.isEmpty(autoGenerated) || !autoGenerated) && (OPF.isEmpty(inherited) || !inherited)) {
                                    modelsToDelete.push(models[i]);
                                }
                            }
                            if (models.length > modelsToDelete.length) {
                                Ext.Msg.alert('Warning', 'Could not delete auto-generated or inherited fields.');
                            }
                            if (modelsToDelete.length > 0) {
                                grid.store.remove(modelsToDelete);
                            }
                        }
                    }
                }
            ],
            listeners: {
                itemdblclick: function(grid, record, item, index) {
                    var autoGenerated = record.get('autoGenerated');
                    var inherited = record.get('inherited');
                    if (!autoGenerated && !inherited) {
                        instance.getEditorDialog().startEditing(index);
                    }
                }
            }
        });

        this.items = [
            this.grid
        ];

        this.callParent(arguments);
    },

    getEditorDialog: function() {
        var editorDialog = Ext.WindowMgr.get('fieldEditorDialog');
        if (OPF.isEmpty(editorDialog)) {
            editorDialog = new OPF.core.component.editor.FieldEditorDialog(this);
            Ext.WindowMgr.register(editorDialog);
        } else {
            editorDialog.setGrid(this);
        }
        return editorDialog;
    },

    cleanFieldStore: function() {
        this.store.removeAll();
    }

});